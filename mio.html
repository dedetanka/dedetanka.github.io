<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>one reading my TANKA</title>
  <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho+B1&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Shippori Mincho B1', serif;
      background-color: #ffe0e0;
      overflow-y: auto;
    }
    .container {
      padding: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .title {
      font-size: 4.5em;
      text-align: center;
      margin-top: 100px;
      margin-bottom: 60px;
      color: #a00;
    }
    .tanka {
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-size: 3.8em;
      line-height: 2.1;
      max-width: 90vw;
      white-space: nowrap;
      text-align: center;
      letter-spacing: 0.1em;
      margin-bottom: 120px;
    }
    ruby {
      ruby-position: over;
      line-height: 1;
      display: inline-block;
      white-space: nowrap;
    }
    rt {
      font-size: 0.7em;
      line-height: 1;
      white-space: nowrap;
    }
    .next-link {
      text-align: center;
      margin-bottom: 100px;
    }
    .next-link a {
      font-size: 3.8em;
      text-decoration: none;
      color: #a00;
    }
    .read-button {
      font-size: 2.5em;
      padding: 0.3em 1em;
      background: #a00;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 40px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title" id="top">mio</div>
    <div class="tanka" id="tanka"></div>
    <!-- <button class="read-button" onclick="speakTanka()">読み上げ</button> -->
    <button class="read-button" onclick="speakTankaWithFallback()">読み上げ</button>
  </div>

  <div class="next-link">
    <a href="#" onclick="scrollToTopAndReload()">next</a>
  </div>

  <script>
    const tankas = [
      "つい<ruby><rb>添</rb><rt>そ</rt></ruby>える「エビ入ってます？」と<ruby><rb>注文</rb><rt>ちゅうもん</rt></ruby>に　アレルギーのはず、<ruby><rb>私</rb><rt>あたし</rt></ruby>ではなく",
      "<ruby><rb>おむすび</rb></ruby>の<ruby><rb>塩</rb><rt>しお</rt></ruby>にこめかみぐむってされ　これでも<ruby><rb>栄養</rb><rt>えいよう</rt></ruby>、ある<ruby><rb>方</rb><rt>ほう</rt></ruby>だから",
      "<ruby><rb>薬</rb><rt>くすり</rt></ruby>して<ruby><rb>呼気</rb><rt>こき</rt></ruby>が「ぐ」を<ruby><rb>戻</rb><rt>もど</rt></ruby>せたら　<ruby><rb>水</rb><rt>みず</rt></ruby>かきつまむ　あなたの<ruby><rb>力</rb><rt>ちから</rt></ruby>で",
      "<ruby><rb>来月</rb><rt>らいげつ</rt></ruby>に<ruby><rb>部屋</rb><rt>へや</rt></ruby>の<ruby><rb>明</rb><rt>あ</rt></ruby>かり<ruby><rb>切</rb><rt>き</rt></ruby>れるから　<ruby><rb>買</rb><rt>か</rt></ruby>い<ruby><rb>替</rb><rt>か</rt></ruby>えたいか<ruby><rb>考</rb><rt>かんが</rt></ruby>えておいて"
    ];
  </script>

    const tankaElement = document.getElementById("tanka");
    const randomIndex = Math.floor(Math.random() * tankas.length);
    tankaElement.innerHTML = tankas[randomIndex];

    function scrollToTopAndReload() {
      document.body.scrollTop = 0;
      document.documentElement.scrollTop = 0;
      location.reload();
    }

    /*
    function speakTanka() {
      const temp = document.createElement("div");
      temp.innerHTML = tankaElement.innerHTML;
  
      // rubyからふりがな（rt）のみを抽出
      temp.querySelectorAll("ruby").forEach(ruby => {
        const rt = ruby.querySelector("rt");
        if (rt) {
          ruby.replaceWith(rt.textContent);
        } else {
          ruby.replaceWith(ruby.textContent);
        }
      });
  
      let text = temp.textContent.replace(/\s+/g, ' ').trim();
      
      // スペースを休符に変える（句点にすることで間ができる）
      text = text.replace(/ /g, '……'); // ←「、」の方が自然な間になります
  
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'ja-JP';
      utter.rate = 0.6; // ← ここで速度調整（0.1〜10.0）
      speechSynthesis.cancel();
      speechSynthesis.speak(utter);
    }
    */
    function speakTankaWithFallback(voiceName = "Kyoko") {
      const voices = speechSynthesis.getVoices();
      const selectedVoice = voices.find(v => v.name === voiceName);
    
      const temp = document.createElement("div");
      temp.innerHTML = tankaElement.innerHTML;
    
      // ふりがなのみに変換
      temp.querySelectorAll("ruby").forEach(ruby => {
        const rt = ruby.querySelector("rt");
        if (rt) {
          ruby.replaceWith(rt.textContent);
        } else {
          ruby.replaceWith(ruby.textContent);
        }
      });
    
      let text = temp.textContent.replace(/\s+/g, ' ').trim();
      text = text.replace(/ /g, '……'); // スペースを長めの休符に
    
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'ja-JP';
      utter.rate = 0.65;
    
      // 見つかれば指定、なければ無指定（＝ブラウザのデフォルト音声）
      if (selectedVoice) {
        utter.voice = selectedVoice;
      }
    
      speechSynthesis.cancel();
      speechSynthesis.speak(utter);
    }
  </script>
</body>
</html>
